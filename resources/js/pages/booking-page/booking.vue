<template>
    <div id="root">
        <loading 
            :height="128"
            :width="128"
            :transition="`fade`"
            :loader="`dots`"
            :background-color="`#fff`"
            :color="`#38d39f`"
            :active.sync="isLoading" 
            :is-full-page="fullPage">
        </loading>
        <div class="row justify-content-center">
            <booking-page-icon></booking-page-icon>
            <div class="col-md-12">
                <div class="card mt-5">
                    <div class="card-header">
                        <div class="card-tool">
                            <router-link to="/add-book-entry">
                                <button class="btn btn-outline-primary btn-flat">
                                    <i class="fa fa-plus-circle"></i> Add
                                </button>
                            </router-link>
                        </div>
                    </div>
                    <div class="card-body">
                        <form  @submit.prevent="validateEntries" role="form">
                            <div class="row">
                                <div class="col-md-3">
                                    <div v-if=" pageIn=='page_1'" class="tab-pagination page-1">
                                        <div class="form-group">
                                            <HotelDatePicker 
                                            @check-in-changed="checkInDate"
                                            @check-out-changed="checkOutDate"
                                            :startingDateValue="new Date(form.checkInD)"
                                            :endingDateValue="new Date(form.checkOutD)"
                                            format="YYYY MMM. DD"
                                            :startDate="new Date()"
                                            :minNights="1"
                                            :maxNights="30"
                                            :closeDatepickerOnClickOutside="false"
                                            :showCloseButton="true"
                                            />
                                            <has-error v-if="form.checkInD==''" :form="form" field="checkInD"></has-error>
                                            <has-error v-else-if="form.checkOutD==''" :form="form" field="checkOutD"></has-error>
                                        </div>
                                        <div class="form-group">
                                            <label for="hotel">Hotel</label>
                                            <Select2 id="hotel" v-model="form.hotel" :options="hotels" :settings="{ placeholder: 'Please select hotel', containerCssClass:'form-control' }" @change="isHotelChange" />
                                            <has-error :form="form" field="hotel"></has-error>
                                        </div>
                                        <div class="form-group">
                                            <label for="roomWithRoomType">Room</label>
                                            <Select2 id="roomWithRoomType" v-model="form.roomWithRoomType" :options=" roomWithRoomTypes" :settings="{ placeholder: 'Please select room', containerCssClass:'form-control' }" @change="isRoomWithRoomType" />
                                            <has-error :form="form" field="roomWithRoomType"></has-error>
                                        </div>
                                        <div class="form-group">
                                            <label for="manyRoom">No. of room</label>
                                            <Select2 id="manyRoom" v-model="form.manyRoom" :options="(form.roomWithRoomType!='' ? manyRooms:[])" :settings="{ placeholder: 'Please select how many rooms', containerCssClass:'form-control' }" @change="isManyRoom" />
                                            <has-error :form="form" field="manyRoom"></has-error>
                                        </div>
                                        <div class="form-group">
                                            <label for="rooms_no">Room no.</label>
                                            <multiselect :max="parseInt(form.manyRoom)" @remove="roomsNoOnRemove" @select="roomsNoOnAdd" :class="{ 'is-invalid': form.errors.has('rooms_no') }" v-model="form.rooms_no" label="value" track-by="code" :options="rooms_options" :multiple="true">
                                                <template slot="tag" slot-scope="{ option, remove }"><span :class="option.status" class="multiselect__tag"><span>{{ option.value }}</span><span v-if="option.status=='ready'" :class="option.status" class="custom__remove" @click="remove(option)"><i aria-hidden="true" tabindex="1" class="multiselect__tag-icon"></i></span></span></template>
                                                <span slot="noResult">Oops! No results</span>
                                                <span slot="maxElements">{{form.manyRoom}} allowed item</span>
                                            </multiselect>
                                            <has-error :form="form" field="rooms_no"></has-error>
                                        </div>
                                        <div class="form-group">
                                            <label for="manyAdult">No. of adult</label>
                                            <Select2 id="manyAdult" v-model="form.manyAdult" :options="(form.manyRoom!='' ? manyAdults:[])" :settings="{ placeholder: 'Please select how many adult(s)', containerCssClass:'form-control' }" />
                                            <has-error :form="form" field="manyAdult"></has-error>
                                        </div>
                                        <div class="form-group">
                                            <label for="manyChild">No. of child</label>
                                            <Select2 id="manyChild" v-model="form.manyChild" :options="(form.manyAdult!='' ? manyChilds:[])" :settings="{ placeholder: 'Please select how many child(s)', containerCssClass:'form-control' }" />
                                            <has-error :form="form" field="manyChild"></has-error>
                                        </div>
                                        <div class="row justify-content-center">
                                            <div class="col-md-12">
                                                <div class="container book-rooms-quantity">
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <h5>Room price</h5>
                                                            <ul>
                                                                <li>{{currency}}{{roomPrice}}</li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-12">
                                                            <h5>Sub total</h5>
                                                            <ul>
                                                                <li>{{currency}}{{roomPrice}} x ({{ nightNoFunc() }})night</li>
                                                                <li>{{currency}}{{roomPrice}} x ({{ roomNoFunc() }})no. of room</li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-12">
                                                            <h5>Total</h5>
                                                            <ul>
                                                                <li>{{currency}}{{totalAmountFunc() }}</li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-12">
                                                            <h5>Fixed amenities</h5>
                                                            <ul>
                                                                <li v-for="item in optionalAmenities">{{item}}</li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-12">
                                                            <h5>Optional amenities</h5>
                                                            <ul>
                                                                <li v-for="item in fixedAmenities">{{item}}</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group text-center mt-4">
                                            <button :disabled="form.busy" type="submit" class="btn btn-outline-primary btn-flat"><i class="fas fa-concierge-bell"></i> Book Room</button>
                                        </div>
                                    </div>
                                    <div v-else-if=" pageIn=='page_2'" class="tab-pagination page-2">
                                        <i @click="backIsClick" class="btn btn-outline-primary btn-flat fas fa-arrow-left"></i>
                                        <div class="form-group mt-4">
                                            <label for="summary">Booking Summary </label>
                                            <div class="summary-container">

                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="name">Name <span class="required-asterisk">*</span></label>
                                            <input type="text" class="form-control" :class="{ 'is-invalid': form.errors.has('name') }" id="name">
                                            <has-error :form="form" field="name"></has-error>
                                        </div>
                                        <div class="form-group">
                                            <label for="phone_no">Phone no. <span class="required-asterisk">*</span></label>
                                            <input type="text" class="form-control" :class="{ 'is-invalid': form.errors.has('phone_no') }" id="phone_no">
                                            <has-error :form="form" field="phone_no"></has-error>
                                        </div>
                                        <div class="form-group">
                                            <label for="email">Email </label>
                                            <input type="email" class="form-control" :class="{ 'is-invalid': form.errors.has('email') }" id="email">
                                            <i>Note: if not empty system will send receipt.</i>
                                        </div>
                                        <div class="form-group">
                                            <label for="address">Address </label>
                                            <input type="text" class="form-control" :class="{ 'is-invalid': form.errors.has('address') }" id="address">
                                        </div>
                                        <div class="form-group text-center mt-4">
                                            <button :disabled="form.busy" type="submit" class="btn btn-outline-primary btn-flat"><i class="fas fa-thumbs-up"></i> Done</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <div id="calendar-menu">
                                        <div class="row mt-0 room-cell-container">
                                            <div class="col-md-3 pr-0 pl-0">
                                                <h5 class="text-center mt-3">Total Rooms</h5>
                                                <h3 class="text-center">{{manyRooms.length}}</h3>
                                            </div>
                                            <div class="col-md-3 pr-0 pl-0">
                                                <h5 class="text-center mt-3">Available Rooms</h5>
                                                <h3 class="text-center">6</h3>
                                            </div>
                                            <div class="col-md-3 pr-0 pl-0">
                                                <h5 class="text-center mt-3">Reserved Rooms</h5>
                                                <h3 class="text-center">2</h3>
                                            </div>
                                            <div class="col-md-3 pr-0 pl-0">
                                                <h5 class="text-center mt-3">Occupied Rooms</h5>
                                                <h3 class="text-center">2</h3>
                                            </div>
                                        </div><br />
                                        <select v-model="selectedView" class="menuSelectedView">
                                            <option v-for="(options, index) in viewModeOptions" :value="options.value" :key="index">{{options.title}}</option>
                                        </select>
                                        <span id="menu-navi" @click="onClickNavi($event)">
                                            <!-- <button type="button" class="btn btn-default btn-sm move-today" data-action="move-today">Today</button> -->
                                            &nbsp;<button v-if="disPrev==false" :disabled="disPrev" type="button" class="btn btn-outline-primary btn-flat move-day" data-action="move-prev"><i class="fas fa-chevron-left" data-action="move-prev"></i> Prev</button>
                                            &nbsp;<button v-if="disNext==false" :disabled="disNext" type="button" class="btn btn-outline-primary btn-flat move-day" data-action="move-next">Next <i class="fas fa-chevron-right" data-action="move-next"></i></button>
                                        </span>
                                        <span class="render-range">{{dateRange}}</span>
                                    </div>
                                    <calendar ref="mycalendar" style="height: 800px;"
                                        :view="selectedView"
                                        :theme="theme"
                                        :calendars="calendarList"
                                        :schedules="scheduleList"
                                    />
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
import 'tui-calendar/dist/tui-calendar.css'
import { Calendar } from '@toast-ui/vue-calendar'
import 'tui-date-picker/dist/tui-date-picker.css'
import HotelDatePicker from 'vue-hotel-datepicker'
import Select2 from 'v-select2-component'
import Loading from 'vue-loading-overlay'
import Multiselect from 'vue-multiselect'
import { parse } from 'path'
export default {
    name: 'myCalendar',
    components: {
        Calendar,
        HotelDatePicker,
        Select2,
        Multiselect,
        Loading
    },
    data() {
        return {
            fullPage: true,
            isLoading: false,
            hotels:[],
            roomWithRoomTypes:[],
            manyRooms: [],
            totalRooms: [],
            manyAdults:[],
            totalAdults:[],
            manyChilds:[],
            totalChilds:[],
            tempFixedAmenities: [],
            tempOptionalAmenities: [],
            fixedAmenities: [],
            optionalAmenities: [],
            disNext: true,
            disPrev: true,
            tempData: [],
            pageIn: 'page_1',
            roomPrices:[],
            roomPrice: 0,
            nightNo: 0,
            currency: '',
            no_unit_avail: 0,
            tempRoomOptions: [],
            rooms_options: [],
            form: new form({
                hotel: '',
                checkInD: new Date().toString(),
                checkOutD: new Date(new Date().getTime()+(60 * 60 * 24 * 1000)).toString(),
                manyAdult: '',
                manyChild: '',
                manyRoom:'',
                roomWithRoomType:'',
                rooms_no: []
            }),
            calendarList: [
                {
                    id: '0',
                    name: 'reserved'
                },
                {
                    id: '1',
                    name: 'occupied',
                    color: 'white',
                    bgColor: '#3490dc',
                    borderColor: '#3490dc',
                    dragBgColor: '#9e5fff'
                }
            ],
            scheduleList: [
                {
                    id: '1',
                    calendarId: '1',
                    title: 'my schedule',
                    category: 'time',
                    dueDateClass: '',
                    start: '2019-12-18T22:30:00+09:00',
                    end: '2019-12-19T02:30:00+09:00'
                },
                {
                    id: '2',
                    calendarId: '1',
                    title: 'second schedule',
                    category: 'time',
                    dueDateClass: '',
                    start: '2019-12-18T17:30:00+09:00',
                    end: '2019-12-19T17:31:00+09:00'
                }
            ],
            viewModeOptions: [
                {
                title: 'Monthly',
                value: 'month'
                },
                {
                title: 'Weekly',
                value: 'week'
                },
                {
                title: 'Daily',
                value: 'day'
                }
            ],
            dateRange: '',
            selectedView: 'month',
            theme: {
                // month header 'dayname'
                'month.dayname.height': '42px',
                'month.dayname.borderLeft': 'none',
                'month.dayname.paddingLeft': '8px',
                'month.dayname.paddingRight': '0',
                'month.dayname.fontSize': '13px',
                'month.dayname.backgroundColor': 'inherit',
                'month.dayname.fontWeight': 'normal',
                'month.dayname.textAlign': 'left',

                // month day grid cell 'day'
                'month.holidayExceptThisMonth.color': '#f3acac',
                'month.dayExceptThisMonth.color': '#bbb',
                'month.weekend.backgroundColor': '#fafafa',
                'month.day.fontSize': '16px',

                // month schedule style
                'month.schedule.height': '18px',
                'month.schedule.marginTop': '2px',
                'month.schedule.marginLeft': '10px',
                'month.schedule.marginRight': '10px',

                // month more view
                'month.moreView.boxShadow': 'none',
                'month.moreView.paddingBottom': '0',
                'month.moreView.border': '1px solid #9a935a',
                'month.moreView.backgroundColor': '#f9f3c6',
                'month.moreViewTitle.height': '28px',
                'month.moreViewTitle.marginBottom': '0',
                'month.moreViewTitle.backgroundColor': '#f4f4f4',
                'month.moreViewTitle.borderBottom': '1px solid #ddd',
                'month.moreViewTitle.padding': '0 10px',
                'month.moreViewList.padding': '10px'
            }
        }
    },
    watch: {
        selectedView(e) {
            this.$refs.mycalendar.invoke('changeView', e, true);
            this.setRenderRangeText();
        }
    },
    methods: {
        init() {
            this.loadHotels();
            this.selectedMonth = new Date();
            this.setRenderRangeText();
            //this.$refs.mycalendar.usageStatistics = false;
        },
        roomsNoOnAdd(value) {
            this.no_unit_avail++;
        },
        roomsNoOnRemove(value) {
            this.no_unit_avail--;
        },
        nightNoFunc(){
            return parseInt(Math.ceil(Math.abs(new Date(this.form.checkOutD) - new Date(this.form.checkInD)) / (1000 * 60 * 60 * 24)));
        },
        roomNoFunc() {
            return parseInt(this.form.manyRoom);
        },
        totalAmountFunc() {
            return parseFloat((parseFloat(this.roomPrice) * this.nightNoFunc()) * this.roomNoFunc());
        },
        backIsClick() {
            this.pageIn = 'page_1';
        },
        validateEntries() {
            if(this.$gate.superAdminOrhotelOwnerOrhotelReceptionist()) {
                this.isLoading = true;
                let self = this
                this.form.post('/api/create-book').then(function (response) {
                    self.isLoading = false;
                    toast.fire({
                      timer: 2000,
                      type: 'success',
                      title: 'Room availability confirmed.'
                    })
                    self.pageIn = 'page_2'
                }).catch(function (error) {
                    self.isLoading = false;
                    toast.fire({
                      type: 'error',
                      title: 'Something went wrong!'
                    })
                });
            }
        },
        pickerClose(){
            this.form.checkInD = '';
            this.form.checkOutD = '';
            this.disPrev = true;
            this.disNext = true;
            this.resetAllList();
            this.$refs.mycalendar.invoke('setDate', new Date(), true);
            this.setRenderRangeText();
        },
        compareDate() {
            if(this.form.checkOutD!='' && Date.parse(new Date(this.form.checkOutD.getFullYear()+'-'+(this.form.checkOutD.getMonth()+1))) > Date.parse(new Date(this.dateRange))) this.disNext = false;
            else this.disNext = true;
            if(this.form.checkInD!='' && Date.parse(new Date(this.form.checkInD.getFullYear()+'-'+(this.form.checkInD.getMonth()+1))) < Date.parse(new Date(this.dateRange))) this.disPrev = false;
            else this.disPrev = true;
        },
        resetAllList(){
            this.resetList();
            this.form.hotel = '';
            this.form.roomWithRoomType = '';
            this.currency = '';
        },
        resetList(){
            this.form.manyAdult = '';
            this.form.manyChild = '';
            this.form.manyRoom = '';
            this.roomPrice = 0;
            this.form.rooms_no = [];
        },
        generateList(param, kind) {
            var tempParam = [];
            if (param.length > 0) {
                var tempList = (kind!='roomNo') ? param.find(e => parseInt(e.id) === parseInt(this.form.roomWithRoomType)).value : [];
                if(kind=='price')  tempParam.push(tempList);
                else if(kind=='roomNo') {
                    let self = this
                    param.forEach(function(item, key){ 
                        if(parseInt(item.id)==parseInt(self.form.roomWithRoomType)) {
                            const found = tempParam.some(el => el.value === item.value.value);
                            if (!found) tempParam.push(item.value);
                        }
                    });

                }
                else if(kind=='value') tempList.forEach(function(item, key){ tempParam.push(item.value); });
                else if(kind=='total') for(var i=1;i<=parseInt(tempList);i++) tempParam.push({id:i, text:i});
                else if(kind=='many') for(var i=1;i<=(parseInt(tempList)*this.form.manyRoom);i++) tempParam.push({id:i, text:i});
            } 
            
            return tempParam;
        },
        isManyRoom() {
            this.form.rooms_no = [];
            this.rooms_options = this.generateList(this.tempRoomOptions, 'roomNo');
            this.manyAdults = this.generateList(this.totalAdults, 'many');
            this.manyChilds = this.generateList(this.totalChilds, 'many');
            this.manyChilds.unshift({id:0, text:'0'});
        },
        isRoomWithRoomType() {
            this.resetList();
            this.roomPrice = parseFloat(this.generateList(this.roomPrices, 'price')[0]);
            this.manyRooms = this.generateList(this.totalRooms, 'total');
            this.fixedAmenities = this.generateList(this.tempOptionalAmenities, 'value');
            this.optionalAmenities = this.generateList(this.tempFixedAmenities, 'value');
        },
        isHotelChange(){
            if(this.$gate.superAdminOrhotelOwner()) {
                this.resetList();
                this.currency = '';
                this.form.roomWithRoomType = '';
                this.roomPrices = [];
                this.fixedAmenities = [];
                this.optionalAmenities = [];
                this.roomWithRoomTypes = [];
                this.manyRooms = [];
                this.manyChilds = [];
                this.manyAdults = [];
                let self = this;
                axios.get('/api/hotel-with-room-types/'+this.form.hotel).then(
                    function (response) {
                        response.data.forEach(function(item, key) {
                            self.currency = item.room_type_hotel.base_currency.value;
                            if([item.room_type_hotel]!='') {
                                [item.room_type_hotel].forEach(function(item2, key2){
                                    JSON.parse(item2.hotel_rooms_no).forEach(function(item3, key3){
                                        self.tempRoomOptions.push({id:item3.assign_id, value:item3});
                                    });
                                });
                            }
                            if(item.room_type_rooms!='') {
                                item.room_type_rooms.forEach(function(item2, key2){
                                    self.roomPrices.push({id:item2.id, value:item2.price});
                                    self.roomWithRoomTypes.push({id:item2.id, text:item2.name+' - '+item.name});
                                    self.totalRooms.push({id:item2.id, value:item2.total_room, available:'none'});
                                    self.totalAdults.push({id:item2.id, value:item2.max_adult});
                                    self.totalChilds.push({id:item2.id, value:item2.max_child});
                                    self.tempOptionalAmenities.push({id:item2.id, value:JSON.parse(item2.room_feature_optional.value)});
                                    self.tempFixedAmenities.push({id:item2.id, value:JSON.parse(item2.room_feature.value)});
                                });
                            }
                        });
                    });
            }
        },
        loadHotels() {
            if(this.$gate.superAdminOrhotelOwner()) {
                let self = this
                axios.get('/api/hotels').then(
                    function (response) {
                        response.data.forEach(item => {
                            if(item.status=='verified')
                                self.hotels.push({id:item.id, text:item.name});
                        });
                    });
            }
        },
        checkInDate(e) {
            if(e!=null) {
              this.resetAllList();
              this.form.checkInD = e;
              this.$refs.mycalendar.invoke('setDate', e, true);
              this.dateRange = `${e.getFullYear()}-${(e.getMonth()+1)}`;
              this.compareDate();
            }
        },
        checkOutDate(e) {
            if(e!=null) {
              this.resetAllList();
              this.form.checkOutD = e;
              this.compareDate();
            }
        },
        onClickNavi(event) {
            if (event.target.tagName === 'BUTTON') {
                const {target} = event;
                let action = target.dataset ? target.dataset.action : target.getAttribute('data-action');
                action = action.replace('move-', '');
                this.$refs.mycalendar.invoke(action);
                this.setRenderRangeText();
                this.compareDate();
            }
        },
        setRenderRangeText() {
            const {invoke} = this.$refs.mycalendar;
            const view = invoke('getViewName');
            const calDate = invoke('getDate');
            const rangeStart = invoke('getDateRangeStart');
            const rangeEnd = invoke('getDateRangeEnd');
            let year = calDate.getFullYear();
            let month = calDate.getMonth() + 1;
            let date = calDate.getDate();
            let dateRangeText = '';
            let endMonth, endDate, start, end;
            switch (view) {
                case 'month':
                    dateRangeText = `${year}-${month}`;
                    break;
                case 'week':
                    year = rangeStart.getFullYear();
                    month = rangeStart.getMonth() + 1;
                    date = rangeStart.getDate();
                    endMonth = rangeEnd.getMonth() + 1;
                    endDate = rangeEnd.getDate();
                    start = `${year}-${month}-${date}`;
                    end = `${endMonth}-${endDate}`;
                    dateRangeText = `${start} ~ ${end}`;
                    break;
                default:
                    dateRangeText = `${year}-${month}-${date}`;
            }
            this.dateRange = dateRangeText;
        }
    },
    mounted() {
        this.init();

        /**
         * jQuery
         * */ 
        let self = this
        $(document).on('click', '.datepicker__clear-button', function(e){
            self.pickerClose();
        });
    }
}
</script>
<style lang='scss'>
    .book-rooms-quantity {
        border: 1px solid #e5e5e5;
        padding: 20px 10px;
        overflow-y: auto;
        overflow-x: hidden;
        max-height: 14.3rem;
        min-height: 14.3rem;
    }

    .book-rooms-quantity h5 {
        font-size: 12px;
        font-weight: 600;
        padding: 5px 0px;
        margin: 0px;
    }

    .book-rooms-quantity span {
        font-size: 18px;
        font-family: cursive;
    }

    .book-rooms-quantity ul {
        list-style: circle;
        padding: 0px 0px 0px 15px;
    }

    .swal2-loading .swal2-styled {
        border-left-color: #38d39f !important;
        border-right-color: #38d39f !important;
    }

    .summary-container {
        border: 1px solid #e5e5e5;
        min-height: 300px;
        overflow-y: auto;
    }

    .room-cell-container {
        margin: auto;
        margin-top: 10px;
    }

    .room-cell-container div {
        border: 1px solid #e5e5e5;
    }

</style>

